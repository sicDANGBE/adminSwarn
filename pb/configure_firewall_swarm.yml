---
- name: Configuration et Validation du Pare-feu (Swarm + Web)
  hosts: swarm_nodes
  become: yes
  vars:
    # Récupération dynamique des IPs
    cluster_ips: "{{ groups['swarm_nodes'] | map('extract', hostvars, ['ansible_default_ipv4', 'address']) | join(', ') }}"
    # On définit explicitement qui est le Manager pour le ciblage des ports Web
    manager_host: "ovh.core" 

  tasks:
    # --- 1. CONFIGURATION DU PARE-FEU ---
    
    - name: Mise à jour de /etc/nftables.conf
      copy:
        dest: /etc/nftables.conf
        validate: '/usr/sbin/nft -c -f %s'
        content: |
          #!/usr/sbin/nft -f
          flush ruleset
          
          # Définition des IPs de confiance (le cluster)
          define SWARM_NODES = { {{ cluster_ips }} }

          table inet filter {
            chain input {
              type filter hook input priority 0; policy drop;

              # Base
              iifname "lo" accept
              ct state established,related accept
              ip protocol icmp accept
              ip6 nexthdr icmpv6 accept

              # SSH Admin (Port variable Ansible)
              tcp dport {{ ansible_port }} accept

              # ACCES WEB (HTTP/HTTPS)
              # Uniquement sur le Manager, car Traefik est en "mode: host" sur ce noeud
              {% if inventory_hostname == manager_host %}
              tcp dport { 80, 443 } accept
              {% endif %}

              # SWARM (Only from Cluster Nodes)
              ip saddr $SWARM_NODES tcp dport { 2377, 7946 } accept
              ip saddr $SWARM_NODES udp dport { 7946, 4789 } accept
              
              # Protocol ESP (Encryption Overlay)
              ip protocol esp accept
            }
            chain forward {
              type filter hook forward priority 0; policy drop;
              ct state established,related accept
              
              # DOCKER LOCAL
              iifname "docker0" accept
              oifname "docker0" accept

              # DOCKER SWARM OVERLAY
              # Nécessaire pour la communication inter-conteneurs et le routing mesh
              iifname "docker_gwbridge" accept
              oifname "docker_gwbridge" accept
            }
            chain output {
              type filter hook output priority 0; policy accept;
            }
          }
        mode: '0755'
      notify: Reload Nftables

    - name: Application immédiate du pare-feu
      meta: flush_handlers

    # --- 2. VALIDATION SSH (Canari local) ---

    - name: Vérification que SSH est toujours vivant
      wait_for_connection:
        timeout: 10
    
    # --- 3. VALIDATION CROISÉE SWARM (Le vrai test) ---

    - name: Installation de netcat (nécessaire pour le test)
      apt:
        pkg: netcat-openbsd
        state: present

    # ETAPE A : On ouvre une fausse écoute sur le Manager (Port 2377)
    # Option -k pour garder le port ouvert pour tous les workers
    - name: Démarrage simulation Swarm sur le Manager
      command: "timeout 25s nc -lk -p 2377"
      async: 30
      poll: 0
      when: inventory_hostname == manager_host
      register: swarm_listener

    # ETAPE B : Les Workers essaient de toucher le Manager
    - name: Test de connexion Swarm (Worker -> Manager)
      wait_for:
        host: "{{ hostvars[manager_host]['ansible_default_ipv4']['address'] }}"
        port: 2377
        timeout: 10
        state: started
      when: inventory_hostname != manager_host

    # ETAPE C : Nettoyage
    - name: Arrêt de la simulation sur le Manager
      shell: "pkill -f 'nc -lk -p 2377'"
      ignore_errors: yes
      when: inventory_hostname == manager_host

    - name: Succès
      debug:
        msg: "Validation RÉUSSIE : Pare-feu configuré (Web sur Manager, Swarm interne OK)."
      run_once: true

  handlers:
    - name: Reload Nftables
      service: name=nftables state=reloaded