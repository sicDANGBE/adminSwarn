---
- name: Audit de Sécurité et Configuration
  hosts: swarm_nodes
  become: yes
  gather_facts: yes
  vars:
    report_path: "./reports"

  tasks:
    # --- 1. ETAT DU SYSTEME ---
    - name: Vérification de l'OS et Kernel
      command: uname -a
      register: sys_kernel

    - name: Liste des utilisateurs critiques (passwd)
      shell: grep -E '^(root|supadmin|dockremap|debian)' /etc/passwd
      register: sys_users

    # --- 2. DOCKER (Le point critique actuel) ---
    - name: Lecture du daemon.json
      command: cat /etc/docker/daemon.json
      register: docker_conf
      ignore_errors: yes

    - name: Vérification des fichiers de mapping (subuid)
      command: cat /etc/subuid
      register: subuid_file
      ignore_errors: yes

    - name: Statut du Service Docker
      command: systemctl status docker --no-pager
      register: docker_status
      ignore_errors: yes

    - name: Logs récents de Docker (si erreur)
      shell: journalctl -u docker -n 20 --no-pager
      register: docker_logs
      ignore_errors: yes

    - name: Vérification des permissions dossier Docker
      shell: ls -ld /var/lib/docker
      register: docker_perm
      ignore_errors: yes

    # --- 3. RESEAU & SECURITE ---
    - name: Règles NFTables actives
      command: nft list ruleset
      register: nft_rules
      ignore_errors: yes

    - name: Ports en écoute (SS)
      shell: ss -tulnp
      register: net_ports

    - name: Configuration SSH active (sans commentaires)
      shell: grep -vE '^#|^$' /etc/ssh/sshd_config
      register: ssh_conf

    # --- 4. GENERATION DU RAPPORT LOCAL ---
    
    - name: Création du dossier de rapports local
      delegate_to: localhost
      become: no
      file:
        path: "{{ report_path }}"
        state: directory

    - name: Écriture du rapport localement
      delegate_to: localhost
      become: no
      copy:
        dest: "{{ report_path }}/report_{{ inventory_hostname }}.txt"
        content: |
          =============================================
          RAPPORT D'AUDIT : {{ inventory_hostname }}
          Date : {{ ansible_date_time.iso8601 }}
          IP : {{ ansible_default_ipv4.address }}
          =============================================

          [1] NOYAU & OS
          ---------------------------------------------
          {{ sys_kernel.stdout }}

          [2] UTILISATEURS CLES
          ---------------------------------------------
          {{ sys_users.stdout }}

          [3] DOCKER : CONFIGURATION
          ---------------------------------------------
          >> daemon.json :
          {{ docker_conf.stdout | default('Fichier introuvable') }}

          >> subuid mapping :
          {{ subuid_file.stdout | default('Fichier introuvable') }}
          
          >> Permissions /var/lib/docker :
          {{ docker_perm.stdout | default('Dossier introuvable') }}

          [4] DOCKER : SANTE
          ---------------------------------------------
          >> Status SystemD :
          {{ docker_status.stdout | default('Service introuvable') }}

          >> Derniers Logs (Erreurs potentielles) :
          {{ docker_logs.stdout }}

          [5] PARE-FEU (NFTABLES)
          ---------------------------------------------
          {{ nft_rules.stdout | default('Aucune règle chargée') }}

          [6] PORTS OUVERTS
          ---------------------------------------------
          {{ net_ports.stdout }}

          [7] CONFIG SSH
          ---------------------------------------------
          {{ ssh_conf.stdout }}